<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticket_kapital</title>
  <style>
    .ticket {
      font-family: monospace;
      font-size: 12px;
      width: 280px;
      margin: 0 auto;
      border: 1px solid #000;
      padding: 10px;
      position: relative;
      background: white;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 4px;
      border: 1px solid #ddd;
      text-align: left;
    }
    .ticket-header, .ticket-footer {
      text-align: center;
    }
    .ticket-header h2, .ticket-footer p {
      margin: 5px 0;
      color: #007BFF;
      font-size: 30px;
    }
    .ticket1-header h2, .ticket-footer p {
      margin: 5px 0;
      color: #007BFF;
      font-size: 18px;
    }
    .divider {
      border-top: 1px dashed #000;
      margin: 10px 0;
    }
    .share-buttons {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
      z-index: 10;
    }
    .btn-share {
      width: 25px;
      height: 25px;
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
      text-decoration: none;
      transition: transform 0.2s;
    }
    .btn-share:hover {
      transform: scale(1.1);
    }
    .btn-pdf {
      background-color: #DC3545;
    }
    .btn-whatsapp {
      background-color: #25D366;
    }
    .btn-compartir {
      background-color: #007BFF;
    }
    #downloadPDF {
      display: block;
      margin: 10px auto;
      padding: 5px 10px;
      font-size: 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .svg-logo {
      width: 120px;
      height: auto;
      flex-shrink: 0;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    th {
      background-color: #007BFF;
      color: white;
    }
    td:nth-child(2), th:nth-child(2) {
      text-align: center;
    }
    @media print {
     .no-print {
       display: none !important;
     }
    }
    
    /* Estilos para el modal de WhatsApp */
    .whatsapp-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-confirm {
      background-color: #25D366;
      color: white;
    }
    
    .btn-cancel {
      background-color: #6c757d;
      color: white;
    }
  </style>
</head>
<body>

<div class="ticket" id="ticket">
  <!-- Botones de compartir -->
  <div class="share-buttons no-print">
    <div class="btn-share btn-pdf" id="btnPDF" title="Descargar PDF">üìÑ</div>
    <div class="btn-share btn-whatsapp" id="btnWhatsApp" title="Compartir por WhatsApp">üì±</div>
    <div class="btn-share btn-compartir" id="btnCompartir" title="Compartir">üì§</div>
  </div>

  <!-- Contenido del ticket -->
  <div class="ticket-header">
    <h2>Cotizaci√≥n 1.0</h2>
    <div class="svg-logo">
      <svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
        <polygon points="60,140 60,30 90,30 90,150" fill="blue"/>
        <polygon points="50,40 50,30 190,-20 89,50" fill="red"/>
        <line x1="150" y2="5" x2="250" y3="200" style="stroke:red;stroke-width:8"/>
        <text x="140" y="60" fill="blue" font-size="45">PVC</text>
        <text x="110" y="110" fill="red" font-size="33">CIELO RAZOS</text>
      </svg>
    </div>
    <h3 id="sucursal"></h3>
    <div><b>Nit:</b> <span id="nit"></span></div>
    <div><b>Tel√©fono:</b> <span id="telefono"></span></div>
    <div><b>Direcci√≥n:</b> <span id="direccion"></span></div>
  </div>

  <div class="divider"></div>

  <div class="ticket-items">
    <p>
      <strong>Cliente:</strong> <span id="cliente"></span><br />
     <strong>Telefono:</strong> <span id="Telcliente"></span><br />
      <strong>Fecha:</strong> <span id="fecha"></span><br />
      <strong>Id cotizaci√≥n:</strong> <span id="id"></span>
    </p>
    <div class="divider"></div>
    <p>Seg√∫n su solicitud de <strong><span id="metros"></span> m¬≤</strong>, recomendamos la siguiente cantidad de materiales:</p>
  </div>

  <table>
    <thead>
      <tr><th>Producto</th><th>Cantidad</th></tr>
    </thead>
    <tbody>
      <tr><td>L√ÅMINAS</td><td id="laminas"></td></tr>
      <tr><td>PERIMETRALES</td><td id="perimetrales"></td></tr>
      <tr><td>OMEGAS</td><td id="omegas"></td></tr>
      <tr><td>VIGUETAS</td><td id="viguetas"></td></tr>
      <tr><td>√ÅNGULOS</td><td id="angulos"></td></tr>
      <tr><td>TORNILLOS</td><td id="tornillos"></td></tr>
    </tbody>
  </table>

  <br />

  <div class="ticket1-footer">
    <p style="text-align: right;"><strong>Costo materiales:</strong> <span id="costomateriales"></span></p>
    <p style="text-align: right;"><strong>Instalaci√≥n:</strong> <span id="instalacion"></span></p>
    <p style="text-align: right;"><strong>Total:</strong> <strong><span id="total"></span></strong></p>

    <h5>Observaciones</h5>
    <p id="Observaciones"></p>
  </div>

  <div class="footer" style="text-align: center; margin-top: 10px;">
    Gracias por confiar en nosotros.<br/>
    CIELO RAZOS PVC ‚Äì Calidad que resalta tu techo.
  </div>
</div>

<button id="downloadPDF" class="no-print">Descargar PDF</button>

<!-- Modal para WhatsApp -->
<div id="whatsappModal" class="whatsapp-modal no-print">
  <div class="modal-content">
    <h3>üì± Enviar por WhatsApp</h3>
    <p>¬øDeseas enviar la cotizaci√≥n al cliente por WhatsApp?</p>
    <p><strong>Cliente:</strong> <span id="modalCliente"></span></p>
    <p><strong>Tel√©fono:</strong> <span id="modalTelefono"></span></p>
    <div class="modal-buttons">
      <button class="modal-btn btn-confirm" id="confirmWhatsApp">Enviar</button>
      <button class="modal-btn btn-cancel" id="cancelWhatsApp">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const getParam = (key, fallback = 'N/A') => params.get(key) || fallback;

  const fillData = () => {
    const ids = [
      "nit","sucursal", "direccion", "telefono", "fecha", "cliente","Telcliente","id", "metros",
      "laminas", "perimetrales", "omegas", "viguetas", "angulos", "tornillos",
      "costomateriales", "instalacion", "total", "Observaciones"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = getParam(id);
    });
  };

  // Funci√≥n para limpiar n√∫mero de tel√©fono
  const cleanPhoneNumber = (phone) => {
    if (!phone || phone === 'N/A') return null;
    
    // Remover todos los caracteres que no sean n√∫meros
    let cleaned = phone.replace(/\D/g, '');
    
    // Si empieza con 57 (c√≥digo de Colombia), mantenerlo
    if (cleaned.startsWith('57') && cleaned.length > 10) {
      return cleaned;
    }
    
    // Si es un n√∫mero de 10 d√≠gitos, agregar c√≥digo de Colombia
    if (cleaned.length === 10) {
      return '57' + cleaned;
    }
    
    // Si es un n√∫mero de 7-9 d√≠gitos, agregar c√≥digo de √°rea de Colombia y c√≥digo de pa√≠s
    if (cleaned.length >= 7 && cleaned.length <= 9) {
      return '573' + cleaned;
    }
    
    return cleaned.length >= 7 ? cleaned : null;
  };

  // Funci√≥n para generar nombre del archivo PDF
  const generatePDFName = () => {
    const cliente = document.getElementById('cliente').textContent.trim() || 'cliente';
    const sucursal = document.getElementById('sucursal').textContent.trim() || 'ciudad';
    
    const clienteLimpio = cliente.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
    const sucursalLimpia = sucursal.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
    
    return `cotizacion_${clienteLimpio}_PVC_${sucursalLimpia}.pdf`;
  };

  // Funci√≥n mejorada para generar PDF
  const generatePDF = () => {
    return new Promise((resolve, reject) => {
      try {
        const ticket = document.getElementById('ticket');
        
        // Configuraci√≥n mejorada para html2canvas
        html2canvas(ticket, { 
          scale: 3, // Aumentamos la escala para mejor calidad
          useCORS: true,
          allowTaint: true,
          width: 300, // Aumentamos el ancho para evitar recortes
          height: ticket.scrollHeight,
          scrollX: 0,
          scrollY: 0,
          backgroundColor: '#ffffff',
          x: 0,
          y: 0,
          foreignObjectRendering: true
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png', 1.0);
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          // Configuraci√≥n mejorada para el PDF
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          // Convertir p√≠xeles a mm (1px = 0.264583mm)
          const imgWidth = (canvas.width * 0.264583) / 3; // Dividir por la escala
          const imgHeight = (canvas.height * 0.264583) / 3;
          
          // Calcular escala para que quepa en la p√°gina con margen
          const margin = 15; // Margen en mm
          const maxWidth = pdfWidth - (margin * 2);
          const maxHeight = pdfHeight - (margin * 2);
          
          const scaleX = maxWidth / imgWidth;
          const scaleY = maxHeight / imgHeight;
          const scale = Math.min(scaleX, scaleY, 1); // No agrandar m√°s de lo original
          
          const finalWidth = imgWidth * scale;
          const finalHeight = imgHeight * scale;
          
          // Centrar el contenido
          const xPosition = (pdfWidth - finalWidth) / 2;
          const yPosition = margin;

          pdf.addImage(imgData, 'PNG', xPosition, yPosition, finalWidth, finalHeight);
          
          const fileName = generatePDFName();
          pdf.save(fileName);
          resolve({ pdf, fileName });
        }).catch(error => {
          console.error('Error con html2canvas:', error);
          reject(error);
        });
      } catch (error) {
        console.error('Error en generatePDF:', error);
        reject(error);
      }
    });
  };

  // Funci√≥n para generar PDF como blob (para compartir)
  const generatePDFBlob = () => {
    return new Promise((resolve, reject) => {
      try {
        const ticket = document.getElementById('ticket');
        
        html2canvas(ticket, { 
          scale: 3,
          useCORS: true,
          allowTaint: true,
          width: 300,
          height: ticket.scrollHeight,
          scrollX: 0,
          scrollY: 0,
          backgroundColor: '#ffffff',
          x: 0,
          y: 0,
          foreignObjectRendering: true
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png', 1.0);
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          const imgWidth = (canvas.width * 0.264583) / 3;
          const imgHeight = (canvas.height * 0.264583) / 3;
          
          const margin = 15;
          const maxWidth = pdfWidth - (margin * 2);
          const maxHeight = pdfHeight - (margin * 2);
          
          const scaleX = maxWidth / imgWidth;
          const scaleY = maxHeight / imgHeight;
          const scale = Math.min(scaleX, scaleY, 1);
          
          const finalWidth = imgWidth * scale;
          const finalHeight = imgHeight * scale;
          
          const xPosition = (pdfWidth - finalWidth) / 2;
          const yPosition = margin;

          pdf.addImage(imgData, 'PNG', xPosition, yPosition, finalWidth, finalHeight);
          
          const pdfBlob = pdf.output('blob');
          const fileName = generatePDFName();
          
          resolve({ blob: pdfBlob, fileName });
        }).catch(error => {
          reject(error);
        });
      } catch (error) {
        reject(error);
      }
    });
  };

  // Funci√≥n para compartir por WhatsApp
  const shareWhatsApp = () => {
    const clienteElement = document.getElementById('cliente');
    const telefonoElement = document.getElementById('Telcliente');
    
    const cliente = clienteElement.textContent.trim();
    const telefono = telefonoElement.textContent.trim();
    
    // Actualizar modal
    document.getElementById('modalCliente').textContent = cliente || 'No especificado';
    document.getElementById('modalTelefono').textContent = telefono || 'No especificado';
    
    // Mostrar modal
    document.getElementById('whatsappModal').style.display = 'block';
  };

  // Funci√≥n para generar enlace de WhatsApp
  const generateWhatsAppLink = (phoneNumber) => {
    const cliente = document.getElementById('cliente').textContent.trim() || 'Cliente';
    const total = document.getElementById('total').textContent.trim() || 'N/A';
    const fecha = document.getElementById('fecha').textContent.trim() || new Date().toLocaleDateString();
    
    const mensaje = `üè† *COTIZACI√ìN CIELO RAZOS PVC* üè†

Estimado/a ${cliente},

Adjunto encontrar√° su cotizaci√≥n de materiales PVC:

üìã *Detalles:*
‚Ä¢ Fecha: ${fecha}
‚Ä¢ Total: ${total}

‚úÖ *Incluye:*
‚Ä¢ L√°minas PVC
‚Ä¢ Perimetrales 
‚Ä¢ Omegas
‚Ä¢ Viguetas
‚Ä¢ √Ångulos
‚Ä¢ Tornillos

üë∑‚Äç‚ôÇÔ∏è *Instalaci√≥n profesional incluida*

Gracias por confiar en nosotros.
*CIELO RAZOS PVC* - Calidad que resalta tu techo üèÜ`;

    const mensajeCodificado = encodeURIComponent(mensaje);
    return `https://wa.me/${phoneNumber}?text=${mensajeCodificado}`;
  };

  // Event Listeners
  document.getElementById('btnPDF').addEventListener('click', () => {
    generatePDF().catch(error => {
      console.error('Error descargando PDF:', error);
      alert('Error al generar el PDF. Por favor, intenta de nuevo.');
    });
  });

  document.getElementById('btnWhatsApp').addEventListener('click', shareWhatsApp);

  document.getElementById('btnCompartir').addEventListener('click', () => {
    generatePDFBlob().then(({ blob, fileName }) => {
      if (navigator.share && navigator.canShare) {
        const file = new File([blob], fileName, { type: 'application/pdf' });
        
        if (navigator.canShare({ files: [file] })) {
          navigator.share({
            title: 'Cotizaci√≥n PVC',
            text: 'Cotizaci√≥n de materiales PVC',
            files: [file]
          }).catch(error => {
            console.log('Compartir cancelado:', error);
            // Fallback: descargar
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
          });
        } else {
          // Fallback
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
        }
      } else {
        // Fallback
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
      }
    }).catch(error => {
      console.error('Error compartiendo:', error);
      alert('Error al generar el PDF para compartir.');
    });
  });

  document.getElementById('downloadPDF').addEventListener('click', () => {
    generatePDF().catch(error => {
      console.error('Error descargando PDF:', error);
      alert('Error al generar el PDF. Por favor, intenta de nuevo.');
    });
  });

  // Modal WhatsApp event listeners
  document.getElementById('confirmWhatsApp').addEventListener('click', () => {
    const telefono = document.getElementById('Telcliente').textContent.trim();
    const cleanedPhone = cleanPhoneNumber(telefono);
    
    if (cleanedPhone) {
      const whatsappUrl = generateWhatsAppLink(cleanedPhone);
      window.open(whatsappUrl, '_blank');
    } else {
      alert('N√∫mero de tel√©fono no v√°lido. Por favor, verifica el n√∫mero del cliente.');
    }
    
    document.getElementById('whatsappModal').style.display = 'none';
  });

  document.getElementById('cancelWhatsApp').addEventListener('click', () => {
    document.getElementById('whatsappModal').style.display = 'none';
  });

  // Cerrar modal al hacer clic fuera
  window.addEventListener('click', (event) => {
    const modal = document.getElementById('whatsappModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  window.onload = fillData;
</script>

</body>
</html>
